<%- include('../../layouts/dashboard', { title: 'Gestion des Utilisateurs' }) %>

<div class="users-list">
    <div class="card">
        <div class="card-header">
            <h2>Gestion des Utilisateurs</h2>
            <a href="/dashboard/users/create" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Nouvel utilisateur
            </a>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Rôle :</label>
                <select id="roleFilter" onchange="filterUsers()">
                    <option value="">Tous</option>
                    <option value="admin">Administrateur</option>
                    <option value="user">Utilisateur</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Recherche :</label>
                <input 
                    type="text" 
                    id="searchFilter" 
                    placeholder="Nom ou email..."
                    onkeyup="filterUsers()"
                >
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Rôle</th>
                        <th>Statut</th>
                        <th>Dernière connexion</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (users.length === 0) { %>
                        <tr>
                            <td colspan="6" class="text-center">Aucun utilisateur trouvé</td>
                        </tr>
                    <% } else { %>
                        <% users.forEach(function(user) { %>
                            <tr data-role="<%= user.role %>">
                                <td><%= user.username %></td>
                                <td><%= user.email %></td>
                                <td>
                                    <span class="badge badge-<%= user.role %>">
                                        <%= user.role === 'admin' ? 'Administrateur' : 'Utilisateur' %>
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge status-<%= user.active ? 'active' : 'inactive' %>">
                                        <%= user.active ? 'Actif' : 'Inactif' %>
                                    </span>
                                </td>
                                <td>
                                    <%= user.lastLogin ? formatDate(user.lastLogin) : 'Jamais connecté' %>
                                </td>
                                <td class="actions">
                                    <a href="/dashboard/users/<%= user.email %>" class="btn btn-icon" title="Voir">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/dashboard/users/<%= user.email %>/edit" class="btn btn-icon" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <% if (currentUser.email !== user.email) { %>
                                        <button 
                                            onclick="toggleUserStatus('<%= user.email %>', <%= user.active %>)" 
                                            class="btn btn-icon <%= user.active ? 'btn-warning' : 'btn-success' %>" 
                                            title="<%= user.active ? 'Désactiver' : 'Activer' %>"
                                        >
                                            <i class="fas fa-<%= user.active ? 'ban' : 'check' %>"></i>
                                        </button>
                                        <button 
                                            onclick="confirmDelete('<%= user.email %>')" 
                                            class="btn btn-icon btn-danger" 
                                            title="Supprimer"
                                        >
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function filterUsers() {
    const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr[data-role]');

    rows.forEach(row => {
        const role = row.dataset.role;
        const text = row.textContent.toLowerCase();
        const roleMatch = !roleFilter || role === roleFilter;
        const searchMatch = !searchFilter || text.includes(searchFilter);
        
        row.style.display = roleMatch && searchMatch ? '' : 'none';
    });
}

function toggleUserStatus(email, currentStatus) {
    const action = currentStatus ? 'désactiver' : 'activer';
    if (confirm(`Êtes-vous sûr de vouloir ${action} cet utilisateur ?`)) {
        fetch(`/dashboard/users/${email}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert(`Erreur lors de l'action`);
            }
        });
    }
}

function confirmDelete(email) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
        fetch(`/dashboard/users/${email}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        });
    }
}
</script>

<style>
.badge-admin {
    background: var(--primary-color);
    color: white;
}

.badge-user {
    background: var(--secondary-color);
    color: white;
}

.status-active {
    background: var(--success-color);
}

.status-inactive {
    background: var(--warning-color);
}

.btn-warning {
    color: var(--warning-color);
}

.btn-warning:hover {
    background: var(--warning-color);
    color: white;
}

.btn-success {
    color: var(--success-color);
}

.btn-success:hover {
    background: var(--success-color);
    color: white;
}
</style> 